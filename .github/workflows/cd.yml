name: CD

on:
  push:
    branch:
      - main

jobs:
  build-docker:
    name: ðŸ”¨ Build Docker
    strategy:
      matrix:
        include:
          - 
            adapter_name: postgres
            dbt_version: 1.4.6
            elementary_version: 0.7.7
          - 
            adapter_name: snowflake
            dbt_version: 1.4.2
            elementary_version: 0.7.7
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v3

      - name: â¬‡ï¸ Set up QEMU
        uses: docker/setup-qemu-action@v2
        
      - name: â¬‡ï¸ Setup buildx
        id: buildx
        uses: docker/setup-buildx-action@v2
        with:
          buildkitd-flags: --debug

      - name: ðŸ”‘ Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ Generate tag
        id: tag
        run: "\
          echo \"TAG=\
          ghcr.io/techonomydev/dbt-runner-serverless:\
          adapter-${{ matrix.adapter_name }}\
          -dbt-${{ matrix.dbt_version }}\
          -elementary-${{ matrix.elementary_version }}\
          \" >> $GITHUB_ENV"

      - name: ðŸ”¨ Build the docker image
        id: docker_build
        uses: docker/build-push-action@v4
        with:
          context: .
          platforms: linux/amd64,
          load: true
          build-args: |
            DBT_PACKAGE=dbt-${{ matrix.adapter_name }}==${{ matrix.dbt_version }}
            ELEMENTARY_PACKAGE=elementary-data[${{ matrix.adapter_name }}]==${{ matrix.elementary_version }}
          tags: ${{ env.TAG }}

      - name: ðŸ§ª Test dbt on the docker image
        # Check if dbt is available from the docker
        run: |
          docker run \
          --entrypoint dbt \
          ${{ env.TAG }} \
          --version
      
      - name: ðŸ§ª Test elementary on the docker image
        # Check if dbt is available from the docker
        run: |
          docker run \
          --entrypoint edr \
          ${{ env.TAG }} \
          --help

      - name: ðŸš€ Deploy the docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          platforms: linux/amd64,
          push: true
          build-args: |
            DBT_PACKAGE=dbt-${{ matrix.adapter_name }}==${{ matrix.dbt_version }}
            ELEMENTARY_PACKAGE=elementary-data[${{ matrix.adapter_name }}]==${{ matrix.elementary_version }}
          tags: ${{ env.TAG }}
